# CI å·¥ä½œæµ - æ¯æ¬¡æäº¤å’Œ PR æ—¶è¿è¡Œã€‚
name: CI

# è§¦å‘æ¡ä»¶ï¼šæ‰€æœ‰åˆ†æ”¯çš„ push å’Œ PRã€‚
on:
  push:
  pull_request:

jobs:
  lint-and-test:
    runs-on: ubuntu-latest

    # çŸ©é˜µç­–ç•¥ï¼šåœ¨å¤šä¸ª Node.js ç‰ˆæœ¬ä¸Šå¹¶è¡Œæµ‹è¯•ã€‚
    strategy:
      matrix:
        node-version: [22, 24, 25]

    steps:
      # ===========================
      # æ­¥éª¤ 1: æ‹‰å–ä»£ç 
      # ===========================
      - name: æ‹‰å–ä»£ç 
        uses: actions/checkout@v4

      # ===========================
      # æ­¥éª¤ 2: å®‰è£… Node.js
      # ===========================
      - name: å®‰è£… Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: "${{ matrix.node-version }}"
          cache: "npm"

      # ===========================
      # æ­¥éª¤ 3: å®‰è£…ä¾èµ–
      # ===========================
      - name: å®‰è£…é¡¹ç›®ä¾èµ–
        run: |
          echo "::group::å®‰è£…ä¾èµ–ä¸­..."
          npm ci
          echo "::endgroup::"
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

      # ===========================
      # æ­¥éª¤ 4: ä»£ç é£æ ¼æ£€æŸ¥
      # ===========================
      - name: è¿è¡Œ ESLint ä»£ç æ£€æŸ¥
        run: |
          echo "::group::ESLint ä»£ç é£æ ¼æ£€æŸ¥ä¸­..."
          npm run lint
          echo "::endgroup::"
          echo "âœ… ESLint æ£€æŸ¥é€šè¿‡"

      # ===========================
      # æ­¥éª¤ 5: TypeScript ç±»å‹æ£€æŸ¥
      # ===========================
      - name: TypeScript ç±»å‹æ£€æŸ¥
        run: |
          echo "::group::TypeScript ç±»å‹æ£€æŸ¥ä¸­..."
          npx tsc --noEmit
          echo "::endgroup::"
          echo "âœ… TypeScript ç±»å‹æ£€æŸ¥é€šè¿‡"

      # ===========================
      # æ­¥éª¤ 6: è¿è¡Œå•å…ƒæµ‹è¯•
      # ===========================
      - name: è¿è¡Œå•å…ƒæµ‹è¯•
        run: |
          echo "::group::è¿è¡Œå•å…ƒæµ‹è¯•ä¸­..."
          npm run test:run
          echo "::endgroup::"
          echo "âœ… æ‰€æœ‰å•å…ƒæµ‹è¯•é€šè¿‡"

      # ===========================
      # æ­¥éª¤ 7: æ„å»ºé¡¹ç›®
      # ===========================
      - name: æ„å»ºé¡¹ç›®
        run: |
          echo "::group::æ„å»ºé¡¹ç›®ä¸­..."
          npm run build
          echo "::endgroup::"
          echo "âœ… é¡¹ç›®æ„å»ºå®Œæˆ"

      # ===========================
      # æ­¥éª¤ 8: éªŒè¯æ„å»ºäº§ç‰©
      # ===========================
      - name: éªŒè¯æ„å»ºäº§ç‰©
        run: |
          echo "éªŒè¯æ„å»ºäº§ç‰©æ–‡ä»¶..."
          test -f dist/index.js && echo "âœ… dist/index.js" || exit 1
          test -f dist/index.cjs && echo "âœ… dist/index.cjs" || exit 1
          test -f dist/cli.js && echo "âœ… dist/cli.js" || exit 1
          test -f dist/cli.cjs && echo "âœ… dist/cli.cjs" || exit 1
          test -f dist/index.d.ts && echo "âœ… dist/index.d.ts" || exit 1
          test -f dist/cli.d.ts && echo "âœ… dist/cli.d.ts" || exit 1
          echo "âœ… æ‰€æœ‰æ„å»ºäº§ç‰©éªŒè¯é€šè¿‡"

      # ===========================
      # æ­¥éª¤ 9: å®Œæˆ
      # ===========================
      - name: CI æ£€æŸ¥å®Œæˆ
        run: |
          echo ""
          echo "=========================================="
          echo "ğŸ‰ CI æ£€æŸ¥å…¨éƒ¨é€šè¿‡ï¼"
          echo "Node.js ç‰ˆæœ¬: ${{ matrix.node-version }}"
          echo "=========================================="
